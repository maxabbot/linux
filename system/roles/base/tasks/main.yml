---
# =============================================================================
# Base Role â€” Tasks
# =============================================================================

# --- Locale Configuration ---

- name: Ensure en_US UTF-8 locale is generated
  community.general.locale_gen:
    name: "{{ item }}"
    state: present
  become: true
  loop:
    - en_US.UTF-8
    - en_NZ.UTF-8
  failed_when: false

- name: Set system locale
  ansible.builtin.lineinfile:
    path: /etc/locale.conf
    line: "LANG=en_US.UTF-8"
    regexp: "^LANG="
    create: true
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Detect CPU vendor for microcode
  ansible.builtin.command: grep -m1 vendor_id /proc/cpuinfo
  register: cpu_vendor
  changed_when: false
  failed_when: false

- name: Set microcode package
  ansible.builtin.set_fact:
    microcode_package: "{{ 'amd-ucode' if 'AuthenticAMD' in cpu_vendor.stdout else 'intel-ucode' }}"

- name: Install microcode package
  community.general.pacman:
    name: "{{ microcode_package }}"
    state: present
  become: true

- name: Install core system packages
  community.general.pacman:
    name: "{{ base_core_packages }}"
    state: present
  become: true

- name: Install networking packages
  community.general.pacman:
    name: "{{ base_network_packages }}"
    state: present
  become: true

- name: Install filesystem tools
  community.general.pacman:
    name: "{{ base_filesystem_packages }}"
    state: present
  become: true

- name: Install Wayland / display packages
  community.general.pacman:
    name: "{{ base_display_packages }}"
    state: present
  become: true

- name: Install CLI tools
  community.general.pacman:
    name: "{{ base_cli_packages }}"
    state: present
  become: true

- name: Install fonts
  community.general.pacman:
    name: "{{ base_font_packages }}"
    state: present
  become: true

- name: Install desktop service packages
  community.general.pacman:
    name: "{{ base_service_packages }}"
    state: present
  become: true

- name: Install security packages
  community.general.pacman:
    name: "{{ base_security_packages }}"
    state: present
  become: true

- name: Install kernel packages
  community.general.pacman:
    name: "{{ base_kernel_packages }}"
    state: present
  become: true

- name: Install power management packages
  community.general.pacman:
    name: "{{ power_management_packages[power_management | default('power-profiles-daemon')] }}"
    state: present
  become: true
  when: (power_management | default('power-profiles-daemon')) in power_management_packages

- name: Install GUFW
  community.general.pacman:
    name: "{{ gufw_packages }}"
    state: present
  become: true
  when: enable_gufw | default(false) | bool

- name: Enable base services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop: "{{ base_services }}"
  become: true
  failed_when: false

- name: Disable conflicting power-profiles-daemon if TLP selected
  ansible.builtin.systemd:
    name: power-profiles-daemon.service
    enabled: false
    state: stopped
  become: true
  when: (power_management | default('power-profiles-daemon')) == 'tlp'
  failed_when: false

- name: Disable conflicting TLP if power-profiles-daemon selected
  ansible.builtin.systemd:
    name: tlp.service
    enabled: false
    state: stopped
  become: true
  when: (power_management | default('power-profiles-daemon')) == 'power-profiles-daemon'
  failed_when: false

- name: Enable power management service
  ansible.builtin.systemd:
    name: "{{ (power_management | default('power-profiles-daemon')) }}.service"
    enabled: true
    state: started
  become: true
  when: (power_management | default('power-profiles-daemon')) in ['power-profiles-daemon', 'tlp']
  failed_when: false

- name: Configure reflector for NZ mirrors
  ansible.builtin.copy:
    dest: /etc/xdg/reflector/reflector.conf
    content: |
      --country 'New Zealand,Australia'
      --protocol https
      --latest 10
      --sort rate
      --save /etc/pacman.d/mirrorlist
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Generate user directories
  ansible.builtin.command: xdg-user-dirs-update
  changed_when: false
  become: false
