---
# =============================================================================
# AUR Role â€” Tasks
# Installs the chosen AUR helper (yay or paru)
# =============================================================================

- name: Check if AUR helper is already installed
  ansible.builtin.command: "which {{ aur_helper }}"
  register: aur_check
  changed_when: false
  failed_when: false

- name: Install AUR helper prerequisites
  community.general.pacman:
    name:
      - base-devel
      - git
    state: present
  become: true
  when: aur_check.rc != 0

- name: Clone AUR helper repository
  ansible.builtin.git:
    repo: "{{ aur_helper_url }}"
    dest: "/tmp/{{ aur_helper }}"
    version: master
    depth: 1
  become: false
  when: aur_check.rc != 0

- name: Build AUR helper
  ansible.builtin.command:
    cmd: makepkg -s --noconfirm
    chdir: "/tmp/{{ aur_helper }}"
  become: false
  when: aur_check.rc != 0

- name: Install AUR helper package
  ansible.builtin.shell:
    cmd: "cd /tmp/{{ aur_helper }} && pacman -U --noconfirm *.pkg.tar.zst"
  become: true
  when: aur_check.rc != 0

- name: Clean up AUR helper build directory
  ansible.builtin.file:
    path: "/tmp/{{ aur_helper }}"
    state: absent
  when: aur_check.rc != 0
